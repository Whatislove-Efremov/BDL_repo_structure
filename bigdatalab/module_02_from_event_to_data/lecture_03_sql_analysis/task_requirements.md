# Task Requirements

## Lecture: Анализ SQL и обработка данных

### Homework Description
Это задание состоит из двух основных частей, охватывающих различные аспекты SQL и обработки данных:

**Часть 1: Анализ данных с помощью SQL** - Студенты будут практиковать аналитические SQL-запросы с использованием набора данных EcoMarket. Это включает операции JOIN, фильтрацию с помощью WHERE, группировку и агрегацию, предложения HAVING, подзапросы, оконные функции и сложные аналитические запросы, объединяющие несколько концепций.

**Часть 2: Обработка данных с помощью SQL** - Студенты будут практиковать операции манипулирования и определения данных, включая DML (язык управления данными), DDL (язык определения данных), DCL (язык контроля данных), транзакции, функции и представления для построения платформ данных.

### Requirements

#### Часть 1: Анализ данных с помощью SQL
Студенты должны выполнить следующие упражнения с использованием набора данных EcoMarket:

**Часть 1: JOIN (Связывание данных)**
- Задача 1: Отобразить для каждой продажи название продукта, категорию и адрес магазина

**Часть 2: WHERE (Фильтрация данных)**
- Задача 1: Отобразить все магазины, расположенные в 'Poland'
- Задача 2: Отобразить все транзакции с суммой продаж выше 1500 для продуктов класса B, отсортированные по номеру транзакции

**Часть 3: GROUP BY**
- Задача 1: Показать количество магазинов в каждой стране, отсортированное по количеству магазинов по убыванию

**Часть 4: HAVING**
- Задача 1: Для каждого продукта показать общую сумму продаж и средний чек, где общая сумма продаж превышает 400 000, отсортированную по общей сумме продаж по убыванию

**Часть 5: SUBQUERIES (Подзапросы)**
- Задача 1: Показать имя и фамилию продавца, совершившего продажу с наибольшей стоимостью, и адрес магазина, в котором он работает

**Часть 6: WINDOW FUNCTIONS (Оконные функции)**
- Задача 1: Найти выручку всех немецких магазинов по месяцам и разницу с предыдущим месяцем, отсортированную по месяцам по возрастанию

**Часть 7: Финальное задание**
- Для каждого магазина рассчитать агрегаты продаж и аналитические показатели по странам:
  - Количество продаж (COUNT(sales_id))
  - Общая сумма продаж (SUM(total_price))
  - Оставить только магазины, у которых не менее 2 продаж
  - Рассчитать долю оборота магазина от общего оборота страны
  - Присвоить ранг магазину по сумме продаж внутри своей страны
  - Накопительный оборот по стране, отсортированный по убыванию оборота магазина
  - Отсортировать результат по стране и рангу магазина

#### Часть 2: Обработка данных с помощью SQL
Студенты должны выполнить следующие упражнения:

**Часть 1: Операции DML**
- Вставить два новых продукта в таблицу Products
- Выбрать продукты, где is_allergic = 'Yes' и vitality_days > 0
- Обновить is_allergic для продукта 'Bananas Family Pack' на 'Yes'
- Удалить один из добавленных продуктов
- Проверить все изменения с помощью SELECT * FROM Products

**Часть 2: Операции DDL**
- Создать новую таблицу с именем Data_Layers со столбцами: LayerID (SERIAL, PRIMARY KEY), LayerName (VARCHAR(50), UNIQUE, NOT NULL), Description (TEXT)
- Заполнить столбец LayerName тремя значениями: 'Bronze', 'Silver', 'Gold'
- Добавить столбец manager_email в таблицу Data_Layers (VARCHAR(100))
- Добавить ограничение UNIQUE к столбцу manager_email в таблице shops
- Переименовать столбец address в таблице Shops в shop_address

**Часть 3: Операции DCL**
- Создать новую роль PostgreSQL с именем data_engineer_trainee с простым паролем
- Предоставить роли data_engineer_trainee разрешение SELECT на таблицу Sales
- Протестировать как data_engineer_trainee, пытаясь выполнить SELECT из Sales (должно сработать)
- Попытаться выполнить INSERT новой продажи как data_engineer_trainee (должно завершиться ошибкой)
- Как администратор, предоставить разрешения INSERT и UPDATE на Sales для data_engineer_trainee
- Протестировать INSERT и UPDATE как data_engineer_trainee (теперь должно сработать)

**Часть 4: Расширенные операции DML с транзакциями**
- Увеличить цену всех продуктов категории 'Dairy' на 10%
- Удалить всех сотрудников без каких-либо продаж
- Вставить нового сотрудника и его первую продажу в одной транзакции

**Часть 5: Функции и представления для Gold Layer**
- Создать функцию AvgSalesPerEmployee (PL/pgSQL) для вычисления средней суммы продаж для сотрудника
- Создать представление FullStatShops для агрегированных статистических данных магазинов со столбцами (shop_id, shop_address, country, total_sales_count, total_sales_amount)

**Часть 6: Расширенные операции DML**
- Найти сотрудников с продажами > 1000
- Обновить класс продукта на 'A' для категорий с общей выручкой > 5000
- Установить modify_timestamp (с использованием NOW()) для продуктов без даты

### Информация о наборе данных
Набор данных EcoMarket включает:
- sales (6 758 125 строк) - транзакции продаж
- customers (98 759) - информация о клиентах
- products (452) - подробности о продуктах
- categories (13) - категории продуктов
- employees (23) - информация о сотрудниках
- cities (96) - информация о городах
- countries (206) - информация о странах
- shops (72) - информация о магазинах

### Submission Guidelines
Студенты должны отправить набор файлов:
1. SQL-файл для задачи анализа данных 
2. SQL-файл для задачи обработки данных

Каждая реализация должна быть в отдельных файлах с соответствующими комментариями, объясняющими подход к решению и примерами выводов.

Все SQL-запросы должны должным образом обрабатывать тот факт, что даты хранятся как VARCHAR и требуют явного преобразования с использованием TO_TIMESTAMP при необходимости.
